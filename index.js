require("dotenv").config()
const _ = require('lodash');
const TelegramBot = require("node-telegram-bot-api");
const bot = new TelegramBot(process.env.TELE_TOKEN, { polling: true });

const scenarios = {
  "start": {
    "id": "start",
    "question": {
      "en": "Who are you?",
      "uk": "–•—Ç–æ –≤–∏ —î?"
    },
    "buttons": {
      "military": {
        "id": "military",
        "text": {
          "en": "Military",
          "uk": "–í—ñ–π—Å—å–∫–æ–≤–∏–π"
        }
      },
      "volunteer": {
        "id": "volunteer",
        "text": {
          "en": "Volunteer",
          "uk": "–í–æ–ª–æ–Ω—Ç–µ—Ä"
        }
      },
      "public_figure": {
        "id": "public_figure",
        "text": {
          "en": "Public figure",
          "uk": "–ì—Ä–æ–º–∞–¥—Å—å–∫–∏–π –¥—ñ—è—á"
        }
      },
      "journalist": {
        "id": "journalist",
        "text": {
          "en": "Journalist / blogger",
          "uk": "–ñ—É—Ä–Ω–∞–ª—ñ—Å—Ç / –±–ª–æ–≥–µ—Ä"
        }
      },
      "anonymous": {
        "id": "anonymous",
        "text": {
          "en": "Anonymous / other",
          "uk": "–ê–Ω–æ–Ω / —ñ–Ω—à–µ"
        }
      }
    }
  },
  "success": {
    "id": "success",
    "question": {
      "en": "THANK YOU!\nWe will contact you very soon!",
      "uk": "–î–Ø–ö–£–Ñ–ú–û!\n–ú–∏ –∑–≤'—è–∂–µ–º–æ—Å—è –∑ –≤–∞–º–∏ –¥—É–∂–µ —Å–∫–æ—Ä–æ!"
    },
    "buttons": {
      "start": {
        "id": "start",
        "text": {
          "en": "Add another request",
          "uk": "–ó—Ä–æ–±–∏—Ç–∏ —â–µ –∑–∞–ø–∏—Ç"
        }
      }
    }
  },
  "military": {
    "id": "military",
    "icon": "‚öîÔ∏è",
    "isFinalSequence": true,
    "questionSequence": [
      {
        "field": "name",
        "question": {
          "en": "What's your name?",
          "uk": "–Ø–∫ –≤–∞—Å –∑–≤—É—Ç—å?"
        },
      },
      {
        "field": "rank",
        "question": {
          "en": "What's your rank?",
          "uk": "–Ø–∫–µ –≤–∞—à–µ –∑–≤–∞–Ω–Ω—è?"
        },
      },
      {
        "field": "location",
        "question": {
          "en": "Where are you located?",
          "uk": "–î–µ –≤–∏ –∑–Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å?"
        },
      },
      {
        "field": "unit",
        "question": {
          "en": "What's you unit?",
          "uk": "–ó —è–∫–æ—ó –≤–∏ –í–ß, –±–∞—Ç?"
        },
      },
      {
        "field": "deadline",
        "question": {
          "en": "What's the deadline?",
          "uk": "–ö–æ–ª–∏ –¥–µ–¥–ª–∞–π–Ω?"
        },
      },
      {
        "field": "priority",
        "question": {
          "en": "What's the priority?",
          "uk": "–Ø–∫–∏–π –ø—Ä—ñ–æ—Ä—ñ—Ç–µ—Ç?"
        },
      },
      {
        "field": "request",
        "question": {
          "en": "What's your request?",
          "uk": "–Ø–∫–∞ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞?"
        },
      },
    ],
  },
  "volunteer": {
    "id": "volunteer",
    "question": {
      "en": "Are you requesting or providing help?",
      "uk": "–í–∏ –ø—Ä–æ–ø–æ–Ω—É—î—Ç–µ —á–∏ –ø—Ä–æ—Å–∏—Ç–µ –ø—Ä–æ –¥–æ–ø–æ–º–æ–≥—É?"
    },
    "buttons": {
      "volunteer_provides_help": {
        "id": "volunteer_provides_help",
        "text": {
          "en": "Providing help",
          "uk": "–ü—Ä–æ–ø–æ–Ω—É—é –¥–æ–ø–æ–º–æ–≥—É"
        }
      },
      "volunteer_requests_help": {
        "id": "volunteer_requests_help",
        "text": {
          "en": "Requesting help",
          "uk": "–ü—Ä–æ—à—É –ø—Ä–æ –¥–æ–ø–æ–º–æ–≥—É"
        }
      }
    }
  },
  "volunteer_provides_help": {
    "id": "volunteer_provides_help",
    "icon": "üö®",
    "isFinalSequence": true,
    "questionSequence": [
      {
        "field": "name",
        "question": {
          "en": "What's your name?",
          "uk": "–Ø–∫ –≤–∞—Å –∑–≤—É—Ç—å?"
        },
      },
      {
        "field": "location",
        "question": {
          "en": "Where are you located?",
          "uk": "–î–µ –≤–∏ –∑–Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å?"
        },
      },
      {
        "field": "request",
        "question": {
          "en": "What you provide?",
          "uk": "–©–æ –ø—Ä–æ–ø–æ–Ω—É—î—Ç–µ?"
        },
      },
    ],
  },
  "volunteer_requests_help": {
    "id": "volunteer_requests_help",
    "question": {
      "en": "For who you are asking for help for?",
      "uk": "–î–ª—è –∫–æ–≥–æ –≤–∏ –ø—Ä–æ—Å–∏—Ç–µ –ø—Ä–æ –¥–æ–ø–æ–º–æ–≥—É?"
    },
    "buttons": {
      "volunteer_requests_military_help": {
        "id": "volunteer_requests_military_help",
        "text": {
          "en": "For military",
          "uk": "–î–ª—è –≤—ñ–π—Å—å–∫–æ–≤–∏—Ö"
        }
      },
      "volunteer_requests_civilian_help": {
        "id": "volunteer_requests_civilian_help",
        "text": {
          "en": "For civilians",
          "uk": "–î–ª—è —Ü–∏–≤—ñ–ª—å–Ω–∏—Ö"
        }
      }
    }
  },
  "volunteer_requests_military_help": {
    "id": "volunteer_requests_military_help",
    "icon": "üöë",
    "isFinalSequence": true,
    "questionSequence": [
      {
        "field": "name",
        "question": {
          "en": "What's your name?",
          "uk": "–Ø–∫ –≤–∞—Å –∑–≤—É—Ç—å?"
        },
      },
      {
        "field": "location",
        "question": {
          "en": "Where are you located?",
          "uk": "–î–µ –≤–∏ –∑–Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å?"
        },
      },
      {
        "field": "request",
        "question": {
          "en": "What's your request?",
          "uk": "–Ø–∫–∞ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞?"
        },
      },
    ],
  },
  "volunteer_requests_civilian_help": {
    "id": "volunteer_requests_civilian_help",
    "icon": "üöö",
    "isFinalSequence": true,
    "questionSequence": [
      {
        "field": "name",
        "question": {
          "en": "What's your name?",
          "uk": "–Ø–∫ –≤–∞—Å –∑–≤—É—Ç—å?"
        },
      },
      {
        "field": "location",
        "question": {
          "en": "Where are you located?",
          "uk": "–î–µ –≤–∏ –∑–Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å?"
        },
      },
      {
        "field": "for",
        "question": {
          "en": "Who you are asking for help for?",
          "uk": "–î–ª—è –∫–æ–≥–æ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞?"
        },
      },
      {
        "field": "request",
        "question": {
          "en": "What's your request?",
          "uk": "–Ø–∫–∞ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞?"
        },
      },
    ],
  },
  "public_figure": {
    "id": "public_figure",
    "icon": "üï∫",
    "isFinalSequence": true,
    "questionSequence": [
      {
        "field": "name",
        "question": {
          "en": "What's your name?",
          "uk": "–Ø–∫ –≤–∞—Å –∑–≤—É—Ç—å?"
        },
      },
      {
        "field": "location",
        "question": {
          "en": "Where are you located?",
          "uk": "–î–µ –≤–∏ –∑–Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å?"
        },
      },
      {
        "field": "contact",
        "question": {
          "en": "How can we contact you?",
          "uk": "–Ø–∫ –∑ –≤–∞–º–∏ –∑–≤'—è–∑–∞—Ç–∏—Å—å?"
        },
      },
      {
        "field": "request",
        "question": {
          "en": "What you provide/request?",
          "uk": "–©–æ –ø—Ä–æ–ø–æ–Ω—É—î—Ç–µ/—à—É–∫–∞—î—Ç–µ?"
        },
      },
    ],
  },
  "journalist": {
    "id": "journalist",
    "icon": "üìù",
    "isFinalSequence": true,
    "questionSequence": [
      {
        "field": "name",
        "question": {
          "en": "What's your name?",
          "uk": "–Ø–∫ –≤–∞—Å –∑–≤—É—Ç—å?"
        },
      },
      {
        "field": "organization",
        "question": {
          "en": "What's the name of your organization?",
          "uk": "–Ø–∫ –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è –≤–∞—à–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è?"
        },
      },
      {
        "field": "contact",
        "question": {
          "en": "How can we contact you?",
          "uk": "–Ø–∫ –∑ –≤–∞–º–∏ –∑–≤'—è–∑–∞—Ç–∏—Å—å?"
        },
      },
      {
        "field": "request",
        "question": {
          "en": "What you provide/request?",
          "uk": "–©–æ –ø—Ä–æ–ø–æ–Ω—É—î—Ç–µ/—à—É–∫–∞—î—Ç–µ?"
        },
      },
    ],
  },
  "anonymous": {
    "id": "anonymous",
    "icon": "üåö",
    "isFinalSequence": true,
    "questionSequence": [
      {
        "field": "name",
        "question": {
          "en": "What's your name?",
          "uk": "–Ø–∫ –≤–∞—Å –∑–≤—É—Ç—å?"
        },
      },
      {
        "field": "location",
        "question": {
          "en": "Where are you located?",
          "uk": "–î–µ –≤–∏ –∑–Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å?"
        },
      },
      {
        "field": "contact",
        "question": {
          "en": "How can we contact you?",
          "uk": "–Ø–∫ –∑ –≤–∞–º–∏ –∑–≤'—è–∑–∞—Ç–∏—Å—å?"
        },
      },
      {
        "field": "deadline",
        "question": {
          "en": "What's the deadline?",
          "uk": "–ö–æ–ª–∏ –¥–µ–¥–ª–∞–π–Ω?"
        },
      },
      {
        "field": "request",
        "question": {
          "en": "What you provide/request?",
          "uk": "–©–æ –ø—Ä–æ–ø–æ–Ω—É—î—Ç–µ/—à—É–∫–∞—î—Ç–µ?"
        },
      },
    ],
  },
}

const messages = {
  "military": {
    "en": "Military",
    "uk": "–í—ñ–π—Å—å–∫–æ–≤–∏–π"
  },
  "volunteer": {
    "en": "Volunteer",
    "uk": "–í–æ–ª–æ–Ω—Ç–µ—Ä"
  },
  "volunteer_provides_help": {
    "en": "Volunteer, provides help",
    "uk": "–í–æ–ª–æ–Ω—Ç–µ—Ä, –ø—Ä–æ–ø–æ–Ω—É—î –¥–æ–ø–æ–º–æ–≥—É"
  },
  "volunteer_requests_help": {
    "en": "Volunteer, requests help",
    "uk": "–í–æ–ª–æ–Ω—Ç–µ—Ä, –∑–∞–ø–∏—Ç—É—î –ø—Ä–æ –¥–æ–ø–æ–º–æ–≥—É"
  },
  "volunteer_requests_military_help": {
    "en": "Volunteer, requests help for military",
    "uk": "–í–æ–ª–æ–Ω—Ç–µ—Ä, –∑–∞–ø–∏—Ç—É—î –ø—Ä–æ –¥–æ–ø–æ–º–æ–≥—É –¥–ª—è –≤—ñ–π—Å—å–∫–æ–≤–∏—Ö"
  },
  "volunteer_requests_civilian_help": {
    "en": "Volunteer, requests help for civilians",
    "uk": "–í–æ–ª–æ–Ω—Ç–µ—Ä, –∑–∞–ø–∏—Ç—É—î –ø—Ä–æ –¥–æ–ø–æ–º–æ–≥—É –¥–ª—è —Ü–∏–≤—ñ–ª—å–Ω–∏—Ö"
  },
  "public_figure": {
    "en": "Public figure",
    "uk": "–ì—Ä–æ–º–∞–¥—Å—å–∫–∏–π –¥—ñ—è—á"
  },
  "journalist": {
    "en": "Journalist / blogger",
    "uk": "–ñ—É—Ä–Ω–∞–ª—ñ—Å—Ç / –±–ª–æ–≥–µ—Ä"
  },
  "anonymous": {
    "en": "Anonymous",
    "uk": "–ê–Ω–æ–Ω"
  },
  "name": {
    "en": "Name",
    "uk": "–Ü–º'—è"
  },
  "rank": {
    "en": "Rank",
    "uk": "–ó–≤–∞–Ω–Ω—è"
  },
  "location": {
    "en": "Location",
    "uk": "–õ–æ–∫–∞—Ü—ñ—è"
  },
  "unit": {
    "en": "Unit",
    "uk": "–í–ß/–ë–∞—Ç"
  },
  "deadline": {
    "en": "Deadline",
    "uk": "–î–µ–¥–ª–∞–π–Ω"
  },
  "priority": {
    "en": "Priority",
    "uk": "–ü—Ä—ñ–æ—Ä—ñ—Ç–µ—Ç"
  },
  "request": {
    "en": "Details",
    "uk": "–°—É—Ç—å"
  },
  "for": {
    "en": "For who",
    "uk": "–î–ª—è –∫–æ–≥–æ"
  },
  "contact": {
    "en": "Contact",
    "uk": "–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ"
  },
  "organization": {
    "en": "Organization",
    "uk": "–û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è"
  }
}

const userState = {};

const renderOptions = (buttons, lang = ['uk', 'en'].includes(lang) ? lang : 'uk', ...opts) => ({
  inline_keyboard: _.chunk(Object.values(buttons).map(({ id, text }) => ({
    text: text[lang],
    callback_data: id
  })), 2), ...opts
})

const generateChannelMessage = ({ id, username, first_name, last_name, language_code, scenario, icon, ...data }) => `${icon} ${messages[scenario]['uk']} \\([@${username}](tg://user?id=${id})\\)\n${Object.keys(data).map(key => `${messages[key]['uk']}: ${data[key]}`).join('\n')
  }`


bot.onText(/\/start/, ({ from }) => {
  bot.sendMessage(from.id, scenarios.start.question[from.language_code], { reply_markup: renderOptions(scenarios.start.buttons, from.language_code) });
});

bot.on('callback_query', ({ from: { is_bot, ...from }, message: { message_id, chat: { id } }, data }) => {

  userState[from.id] = userState[from.id]
    ? { ...userState[from.id], scenario: data, icon: scenarios[data] && scenarios[data].icon ? scenarios[data].icon : "‚ö†Ô∏è" }
    : { ...from, scenario: data, icon: scenarios[data] && scenarios[data].icon ? scenarios[data].icon : "‚ö†Ô∏è", _questionIndex: 0 }

  if (data === 'start') {
    bot.deleteMessage(id, message_id);
    bot.sendMessage(id, scenarios.start.question[from.language_code], {
      reply_markup: renderOptions(scenarios[data].buttons, from.language_code)
    });
    return;
  }

  if (!!scenarios[data].buttons) {
    bot.editMessageText(scenarios[data].question[from.language_code], {
      chat_id: id,
      message_id,
      reply_markup: renderOptions(scenarios[data].buttons, from.language_code),
    });
    return;
  } else if (scenarios[data].isFinalSequence) {
    bot.editMessageText(scenarios[data].questionSequence[userState[from.id]._questionIndex].question[from.language_code], { chat_id: id, message_id });
    return;
  }

  return
});

bot.on('message', ({ from, text, from: { id }, ...rest }) => {

  if (!userState[id]) {
    !text.includes('\start') && bot.deleteMessage(rest.chat.id, rest.message_id)
    return
  }
  if (!userState[id].scenario || !scenarios[userState[id].scenario].questionSequence[userState[id]._questionIndex]) return

  if (!scenarios[userState[id].scenario].questionSequence) bot.deleteMessage(rest.chat.id, rest.message_id)

  userState[id][scenarios[userState[id].scenario].questionSequence[userState[id]._questionIndex].field] = text;

  userState[id]._questionIndex++;

  if (userState[id]._questionIndex >= scenarios[userState[id].scenario].questionSequence.length) {
    const { _questionIndex, ...data } = userState[id]
    bot.sendMessage(process.env.TELE_CHANNEL_ID, generateChannelMessage(data), { parse_mode: 'MarkdownV2' });
    setTimeout(() => {
      bot.sendMessage(from.id, scenarios.success.question[from.language_code], { reply_markup: renderOptions(scenarios.success.buttons, from.language_code) });
    }, 1000)
    delete userState[id]
    return;
  }

  bot.sendMessage(id,
    scenarios[userState[id].scenario].questionSequence[userState[id]._questionIndex].question[from.language_code]
  );
});